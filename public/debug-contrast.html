<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Contraste AIPI Widget</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .color-test {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .widget-container {
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>🔍 Debug de Contraste - Widget AIPI</h1>
    
    <div class="debug-container">
        <h2>Panel de Control de Debug</h2>
        <button class="test-button" onclick="testAllColors()">Probar Todos los Colores</button>
        <button class="test-button" onclick="clearLogs()">Limpiar Logs</button>
        <button class="test-button" onclick="testCurrentConfig()">Probar Configuración Actual</button>
        <button class="test-button" onclick="toggleWidget()">Mostrar/Ocultar Widget</button>
        <button class="test-button" onclick="forceOpenWidget()">🚀 Forzar Apertura Widget</button>
        <button class="test-button" onclick="testRealInputDirectly()">🧪 Test Input Real</button>
    </div>

    <div class="debug-container">
        <h2>Pruebas de Colores</h2>
        <div id="colorTests"></div>
    </div>

    <div class="debug-container">
        <h2>Logs de Debug en Tiempo Real</h2>
        <div class="log-output" id="debugLog">Iniciando debug...\n</div>
    </div>

    <div class="widget-container" id="widgetContainer" style="display: none;">
        <h2>Widget AIPI en Vivo</h2>
        <div id="debug-widget-container"></div>
    </div>

    <script>
        // Override console.log para capturar todos los logs
        const originalLog = console.log;
        const debugLogElement = document.getElementById('debugLog');
        
        function logToDebug(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            debugLogElement.textContent += logMessage;
            debugLogElement.scrollTop = debugLogElement.scrollHeight;
            originalLog(message);
        }

        console.log = function(...args) {
            logToDebug(args.join(' '), 'log');
        };

        console.error = function(...args) {
            logToDebug(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            logToDebug(args.join(' '), 'warn');
        };

        // Función para calcular luminancia
        function calculateLuminance(hex) {
            let color = hex.replace('#', '');
            if (color.length === 3) {
                color = color.split('').map(c => c + c).join('');
            }
            if (color.length !== 6) return null;
            
            const r = parseInt(color.substr(0, 2), 16);
            const g = parseInt(color.substr(2, 2), 16);
            const b = parseInt(color.substr(4, 2), 16);
            
            return (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
        }

        // Función para determinar color de texto
        function getTextColor(bgColor, threshold = 0.6) {
            const luminance = calculateLuminance(bgColor);
            return luminance < threshold ? '#ffffff' : '#1f2937';
        }

        // Probar diferentes colores
        function testAllColors() {
            const testColors = [
                '#E5E7EB', // Gris claro (tu configuración)
                '#1b3569', // Azul oscuro (problema reportado)
                '#ffffff', // Blanco
                '#000000', // Negro
                '#f3f4f6', // Gris muy claro
                '#374151', // Gris oscuro
                '#3b82f6', // Azul medio
                '#1f2937', // Gris muy oscuro
            ];

            const container = document.getElementById('colorTests');
            container.innerHTML = '';

            testColors.forEach(color => {
                const luminance = calculateLuminance(color);
                const textColor = getTextColor(color);
                
                console.log(`Testing color ${color}: Luminance=${luminance?.toFixed(3)}, TextColor=${textColor}`);
                
                const testDiv = document.createElement('div');
                testDiv.className = 'color-test';
                testDiv.style.backgroundColor = color;
                testDiv.style.color = textColor;
                testDiv.innerHTML = `
                    <strong>Color: ${color}</strong><br>
                    Luminancia: ${luminance?.toFixed(3) || 'ERROR'}<br>
                    Texto: ${textColor}<br>
                    ¿Legible? ${luminance !== null ? 'SÍ' : 'NO'}
                `;
                
                container.appendChild(testDiv);
            });
        }

        // Probar configuración actual del widget
        function testCurrentConfig() {
            console.log('=== PROBANDO CONFIGURACIÓN ACTUAL ===');
            
            // Simular la configuración actual
            const config = {
                assistantBubbleColor: '#E5E7EB',
                userBubbleColor: '#3b82f6'
            };

            const assistantLuminance = calculateLuminance(config.assistantBubbleColor);
            const assistantTextColor = getTextColor(config.assistantBubbleColor);
            
            console.log(`Configuración Asistente:`);
            console.log(`  Color de fondo: ${config.assistantBubbleColor}`);
            console.log(`  Luminancia: ${assistantLuminance?.toFixed(3)}`);
            console.log(`  Color de texto calculado: ${assistantTextColor}`);
            console.log(`  Umbral usado: 0.6`);
            console.log(`  ¿Es fondo oscuro? ${assistantLuminance < 0.6 ? 'SÍ' : 'NO'}`);
        }

        // Cargar widget real
        function toggleWidget() {
            const container = document.getElementById('widgetContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                loadRealWidget();
            } else {
                container.style.display = 'none';
            }
        }

        function loadRealWidget() {
            console.log('Cargando widget real...');
            
            // Crear un contenedor para el widget
            const widgetDiv = document.createElement('div');
            widgetDiv.id = 'aipi-widget-debug';
            widgetDiv.style.cssText = `
                width: 400px;
                height: 500px;
                border: 2px solid #ddd;
                border-radius: 8px;
                position: relative;
                background: white;
                margin: 20px 0;
            `;
            document.getElementById('debug-widget-container').appendChild(widgetDiv);
            
            // Crear manualmente elementos de prueba
            createTestMessages();
            
            // Crear input de prueba funcional
            createTestInput();
            
            // Limpiar cualquier inicialización previa
            window.AIPPS_WIDGET_INITIALIZED = false;
            
            // También cargar el script real
            const script = document.createElement('script');
            script.src = '/embed.js?key=57031f04127cd041251b1e9abd678439fd199b2f30b75a1f&v=' + Date.now();
            script.onload = function() {
                console.log('Widget cargado exitosamente');
                setTimeout(() => {
                    inspectRealElements();
                    testInputFunctionality();
                }, 2000);
            };
            script.onerror = function() {
                console.error('Error al cargar el widget');
            };
            document.head.appendChild(script);
        }

        function createTestInput() {
            const container = document.getElementById('aipi-widget-debug');
            if (!container) return;

            const testInputDiv = document.createElement('div');
            testInputDiv.style.cssText = `
                background: #f8f9fa;
                padding: 20px;
                margin: 10px;
                border-radius: 8px;
                border: 2px solid #28a745;
            `;

            testInputDiv.innerHTML = `
                <h4 style="margin: 0 0 10px 0; color: #28a745;">🧪 Test de Input - Funcional</h4>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="debug-test-input" placeholder="Escribe aquí para probar..." 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px;">
                    <button id="debug-test-send" disabled style="background: #007bff; color: white; border: none; 
                            border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; 
                            align-items: center; justify-content: center;">
                        ➤
                    </button>
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    Este input debería habilitar el botón cuando escribas
                </small>
            `;

            container.appendChild(testInputDiv);

            // Configurar eventos del input de prueba
            const testInput = document.getElementById('debug-test-input');
            const testSend = document.getElementById('debug-test-send');

            testInput.oninput = function() {
                const hasValue = testInput.value.trim();
                testSend.disabled = !hasValue;
                testSend.style.background = hasValue ? '#28a745' : '#6c757d';
                console.log('🧪 Test Input: value changed to:', testInput.value, 'button enabled:', !testSend.disabled);
            };

            testSend.onclick = function() {
                console.log('🧪 Test Input: Button clicked with value:', testInput.value);
                alert('Test exitoso! Valor: ' + testInput.value);
                testInput.value = '';
                testInput.oninput(); // Trigger para deshabilitar botón
            };

            console.log('✅ Test input creado y configurado');
        }

        function testInputFunctionality() {
            console.log('🔍 Probando funcionalidad de inputs del widget real...');
            
            // Buscar elementos más específicamente
            const realInput = document.querySelector('#aipi-input');
            const realSendButton = document.querySelector('#aipi-send-button');
            const chatPanel = document.querySelector('#aipi-chat-panel');
            const toggleButton = document.querySelector('#aipi-toggle-button');
            
            console.log('🔍 Estado del widget:');
            console.log('  Chat panel encontrado:', !!chatPanel);
            console.log('  Toggle button encontrado:', !!toggleButton);
            console.log('  Input encontrado:', !!realInput);
            console.log('  Send button encontrado:', !!realSendButton);
            
            if (chatPanel) {
                console.log('  Chat panel display:', chatPanel.style.display);
                console.log('  Chat panel visible:', chatPanel.style.display !== 'none');
            }
            
            // Si no hay input o el panel está cerrado, intentar abrir el widget
            if ((!realInput && toggleButton) || (chatPanel && chatPanel.style.display === 'none' && toggleButton)) {
                console.log('🚀 Widget cerrado, intentando abrir...');
                toggleButton.click();
                
                // Esperar y volver a buscar
                setTimeout(() => {
                    const newInput = document.querySelector('#aipi-input');
                    const newSendButton = document.querySelector('#aipi-send-button');
                    const newChatPanel = document.querySelector('#aipi-chat-panel');
                    
                    console.log('📝 Después de abrir widget:');
                    console.log('  Input encontrado:', !!newInput);
                    console.log('  Send button encontrado:', !!newSendButton);
                    console.log('  Chat panel visible:', newChatPanel?.style.display !== 'none');
                    
                    if (newInput && newSendButton) {
                        testRealInput(newInput, newSendButton);
                    } else {
                        console.error('❌ Widget abierto pero sin elementos de input');
                        listAllElements();
                    }
                }, 1500);
            } else if (realInput && realSendButton) {
                testRealInput(realInput, realSendButton);
            } else {
                console.error('❌ No se encontraron elementos del widget real');
                listAllElements();
            }
        }
        
        function testRealInput(realInput, realSendButton) {
            console.log('✅ Probando input real del widget:');
            console.log('  Input:', realInput);
            console.log('  Send button:', realSendButton);
            console.log('  Input disabled:', realInput.disabled);
            console.log('  Send button disabled:', realSendButton.disabled);
            console.log('  Input placeholder:', realInput.placeholder);
            
            // Simular escritura para probar
            setTimeout(() => {
                console.log('🤖 Simulando escritura en el input real...');
                realInput.focus();
                realInput.value = 'Mensaje de prueba';
                realInput.dispatchEvent(new Event('input', { bubbles: true }));
                realInput.dispatchEvent(new Event('change', { bubbles: true }));
                
                setTimeout(() => {
                    console.log('📊 Estado después de simular escritura:');
                    console.log('  Input value:', realInput.value);
                    console.log('  Send button disabled:', realSendButton.disabled);
                    
                    // Intentar click en el botón
                    if (!realSendButton.disabled) {
                        console.log('🎯 Botón habilitado, simulando click...');
                        realSendButton.click();
                    } else {
                        console.log('⚠️ Botón sigue deshabilitado');
                    }
                }, 200);
            }, 500);
        }
        
        function listAllElements() {
            console.log('📋 Todos los elementos con ID que contiene "aipi":');
            const elements = document.querySelectorAll('[id*="aipi"], [class*="aipi"]');
            elements.forEach((el, index) => {
                console.log(`  ${index + 1}. ${el.tagName}#${el.id}.${el.className} - visible: ${el.style.display !== 'none'}`);
            });
        }

        function createTestMessages() {
            const container = document.getElementById('aipi-widget-debug');
            if (!container) return;

            // Mensaje de prueba directo
            const testMessage = document.createElement('div');
            testMessage.className = 'aipi-assistant-message';
            testMessage.style.cssText = `
                background-color: #E5E7EB;
                color: #1f2937;
                padding: 10px 14px;
                border-radius: 18px;
                margin: 10px;
                max-width: 80%;
                border-bottom-left-radius: 4px;
            `;
            testMessage.textContent = 'Mensaje de prueba - ¿Se ve este texto?';
            container.appendChild(testMessage);

            console.log('✅ Mensaje de prueba creado:');
            console.log('  Background:', '#E5E7EB');
            console.log('  Color:', '#1f2937');
            console.log('  Styles applied:', testMessage.style.cssText);

            // Verificar estilos computados
            setTimeout(() => {
                const computed = getComputedStyle(testMessage);
                console.log('📊 Estilos computados:');
                console.log('  background-color:', computed.backgroundColor);
                console.log('  color:', computed.color);
            }, 100);
        }

        function inspectRealElements() {
            const realMessages = document.querySelectorAll('.aipi-assistant-message, .aipi-fs-assistant-message');
            console.log(`🔍 Encontrados ${realMessages.length} mensajes reales del asistente`);
            
            realMessages.forEach((msg, index) => {
                const computed = getComputedStyle(msg);
                console.log(`Mensaje ${index + 1}:`);
                console.log('  Element:', msg);
                console.log('  Classes:', Array.from(msg.classList));
                console.log('  Inline styles:', msg.style.cssText);
                console.log('  Computed background:', computed.backgroundColor);
                console.log('  Computed color:', computed.color);
                console.log('  Parent element:', msg.parentElement?.tagName);
            });
        }

        function clearLogs() {
            debugLogElement.textContent = 'Logs limpiados...\n';
        }

        // Inicializar
        console.log('Debug de contraste iniciado');
        console.log('Configuración detectada: asistente fondo #E5E7EB');
        testCurrentConfig();
        testAllColors();

        // Monitorear cambios en el DOM con análisis detallado
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.classList) {
                            if (node.classList.contains('aipi-assistant-message') || 
                                node.classList.contains('aipi-fs-assistant-message')) {
                                
                                setTimeout(() => {
                                    const computed = getComputedStyle(node);
                                    console.log('🆕 NUEVO mensaje del asistente detectado:');
                                    console.log('  Element:', node.tagName);
                                    console.log('  Classes:', Array.from(node.classList));
                                    console.log('  Inline styles:', node.style.cssText);
                                    console.log('  Computed background:', computed.backgroundColor);
                                    console.log('  Computed color:', computed.color);
                                    console.log('  Text content:', node.textContent?.substring(0, 50) + '...');
                                    
                                    // Verificar cascada de CSS
                                    console.log('🔍 Análisis de cascada CSS:');
                                    const rules = [];
                                    for (let sheet of document.styleSheets) {
                                        try {
                                            for (let rule of sheet.cssRules) {
                                                if (rule.selectorText && node.matches(rule.selectorText)) {
                                                    rules.push({
                                                        selector: rule.selectorText,
                                                        color: rule.style.color,
                                                        background: rule.style.backgroundColor
                                                    });
                                                }
                                            }
                                        } catch (e) {
                                            // Cross-origin stylesheet
                                        }
                                    }
                                    console.log('  Reglas CSS aplicables:', rules);
                                }, 50);
                            }
                        }
                    });
                }
            });
        });

        observer.observe(document.body, { 
            childList: true, 
            subtree: true 
        });
        
        function forceOpenWidget() {
            console.log('🚀 Forzando apertura del widget...');
            const chatPanel = document.querySelector('#aipi-chat-panel');
            if (chatPanel) {
                chatPanel.style.display = 'flex';
                console.log('✅ Chat panel forzado a mostrarse');
                
                // Esperar y probar input
                setTimeout(() => {
                    testRealInputDirectly();
                }, 500);
            } else {
                console.error('❌ No se encontró chat panel');
            }
        }
        
        function testRealInputDirectly() {
            console.log('🧪 Probando input real directamente...');
            const input = document.querySelector('#aipi-input');
            const button = document.querySelector('#aipi-send-button');
            
            if (input && button) {
                console.log('✅ Elementos encontrados, probando funcionalidad...');
                console.log('  Input inicial disabled:', input.disabled);
                console.log('  Button inicial disabled:', button.disabled);
                
                // Simular escritura
                input.focus();
                input.value = 'Test directo';
                
                // Disparar todos los eventos posibles
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
                input.dispatchEvent(new Event('keyup', { bubbles: true }));
                
                setTimeout(() => {
                    console.log('📊 Resultado después de eventos:');
                    console.log('  Input value:', input.value);
                    console.log('  Button disabled:', button.disabled);
                    
                    if (!button.disabled) {
                        console.log('🎉 ¡SUCCESS! El botón se habilitó');
                        // Simular envío
                        button.click();
                        console.log('📤 Click enviado');
                    } else {
                        console.log('❌ El botón sigue deshabilitado');
                        
                        // Intentar habilitar manualmente
                        button.disabled = false;
                        console.log('🔧 Button habilitado manualmente');
                        button.click();
                        console.log('📤 Click enviado después de habilitar manualmente');
                    }
                }, 200);
            } else {
                console.error('❌ No se encontraron elementos:', {
                    input: !!input,
                    button: !!button
                });
            }
        }
    </script>
</body>
</html>